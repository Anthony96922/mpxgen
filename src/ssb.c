/*
 * mpxgen - FM multiplex encoder with Stereo and RDS
 * Copyright (C) 2019-2021 Anthony96922
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include "common.h"
#include "ssb.h"

/*
 * Hilbert transform FIR filter
 *
 * https://www-users.cs.york.ac.uk/~fisher/mkfilter/
 * http://dp.nonoo.hu/projects/ham-dsp-tutorial/09-ssb-hartley/
 */
static float const hilbert_fir[HT_FILTER_SIZE] = {
	+0.0000000000, +0.0003138613, +0.0000000000, +0.0003174376,
	+0.0000000000, +0.0003221740, +0.0000000000, +0.0003280972,
	+0.0000000000, +0.0003352340, +0.0000000000, +0.0003436114,
	+0.0000000000, +0.0003532566, +0.0000000000, +0.0003641970,
	+0.0000000000, +0.0003764603, +0.0000000000, +0.0003900744,
	+0.0000000000, +0.0004050673, +0.0000000000, +0.0004214676,
	+0.0000000000, +0.0004393040, +0.0000000000, +0.0004586054,
	+0.0000000000, +0.0004794011, +0.0000000000, +0.0005017209,
	+0.0000000000, +0.0005255947, +0.0000000000, +0.0005510531,
	+0.0000000000, +0.0005781267, +0.0000000000, +0.0006068469,
	+0.0000000000, +0.0006372454, +0.0000000000, +0.0006693544,
	+0.0000000000, +0.0007032067, +0.0000000000, +0.0007388356,
	+0.0000000000, +0.0007762750, +0.0000000000, +0.0008155595,
	+0.0000000000, +0.0008567243, +0.0000000000, +0.0008998053,
	+0.0000000000, +0.0009448395, +0.0000000000, +0.0009918643,
	+0.0000000000, +0.0010409181, +0.0000000000, +0.0010920405,
	+0.0000000000, +0.0011452719, +0.0000000000, +0.0012006537,
	+0.0000000000, +0.0012582286, +0.0000000000, +0.0013180405,
	+0.0000000000, +0.0013801346, +0.0000000000, +0.0014445576,
	+0.0000000000, +0.0015113575, +0.0000000000, +0.0015805840,
	+0.0000000000, +0.0016522886, +0.0000000000, +0.0017265245,
	+0.0000000000, +0.0018033470, +0.0000000000, +0.0018828134,
	+0.0000000000, +0.0019649832, +0.0000000000, +0.0020499184,
	+0.0000000000, +0.0021376834, +0.0000000000, +0.0022283457,
	+0.0000000000, +0.0023219754, +0.0000000000, +0.0024186459,
	+0.0000000000, +0.0025184340, +0.0000000000, +0.0026214200,
	+0.0000000000, +0.0027276884, +0.0000000000, +0.0028373275,
	+0.0000000000, +0.0029504304, +0.0000000000, +0.0030670949,
	+0.0000000000, +0.0031874241, +0.0000000000, +0.0033115266,
	+0.0000000000, +0.0034395171, +0.0000000000, +0.0035715167,
	+0.0000000000, +0.0037076536, +0.0000000000, +0.0038480636,
	+0.0000000000, +0.0039928907, +0.0000000000, +0.0041422875,
	+0.0000000000, +0.0042964166, +0.0000000000, +0.0044554506,
	+0.0000000000, +0.0046195735, +0.0000000000, +0.0047889815,
	+0.0000000000, +0.0049638842, +0.0000000000, +0.0051445053,
	+0.0000000000, +0.0053310847, +0.0000000000, +0.0055238792,
	+0.0000000000, +0.0057231643, +0.0000000000, +0.0059292361,
	+0.0000000000, +0.0061424131, +0.0000000000, +0.0063630386,
	+0.0000000000, +0.0065914829, +0.0000000000, +0.0068281459,
	+0.0000000000, +0.0070734605, +0.0000000000, +0.0073278960,
	+0.0000000000, +0.0075919615, +0.0000000000, +0.0078662107,
	+0.0000000000, +0.0081512469, +0.0000000000, +0.0084477282,
	+0.0000000000, +0.0087563740, +0.0000000000, +0.0090779724,
	+0.0000000000, +0.0094133886, +0.0000000000, +0.0097635740,
	+0.0000000000, +0.0101295776, +0.0000000000, +0.0105125586,
	+0.0000000000, +0.0109138011, +0.0000000000, +0.0113347310,
	+0.0000000000, +0.0117769368, +0.0000000000, +0.0122421921,
	+0.0000000000, +0.0127324845, +0.0000000000, +0.0132500473,
	+0.0000000000, +0.0137973997, +0.0000000000, +0.0143773929,
	+0.0000000000, +0.0149932668, +0.0000000000, +0.0156487183,
	+0.0000000000, +0.0163479841, +0.0000000000, +0.0170959429,
	+0.0000000000, +0.0178982414, +0.0000000000, +0.0187614506,
	+0.0000000000, +0.0196932631, +0.0000000000, +0.0207027420,
	+0.0000000000, +0.0218006399, +0.0000000000, +0.0229998108,
	+0.0000000000, +0.0243157494, +0.0000000000, +0.0257673042,
	+0.0000000000, +0.0273776363, +0.0000000000, +0.0291755264,
	+0.0000000000, +0.0311971870, +0.0000000000, +0.0334888257,
	+0.0000000000, +0.0361103470, +0.0000000000, +0.0391408311,
	+0.0000000000, +0.0426868713, +0.0000000000, +0.0468956751,
	+0.0000000000, +0.0519764409, +0.0000000000, +0.0582368230,
	+0.0000000000, +0.0661485683, +0.0000000000, +0.0764737425,
	+0.0000000000, +0.0905286557, +0.0000000000, +0.1107996896,
	+0.0000000000, +0.1426148288, +0.0000000000, +0.1998268664,
	+0.0000000000, +0.3332294323, +0.0000000000, +0.9999653629,
	+0.0000000000, -0.9999653629, -0.0000000000, -0.3332294323,
	-0.0000000000, -0.1998268664, -0.0000000000, -0.1426148288,
	-0.0000000000, -0.1107996896, -0.0000000000, -0.0905286557,
	-0.0000000000, -0.0764737425, -0.0000000000, -0.0661485683,
	-0.0000000000, -0.0582368230, -0.0000000000, -0.0519764409,
	-0.0000000000, -0.0468956751, -0.0000000000, -0.0426868713,
	-0.0000000000, -0.0391408311, -0.0000000000, -0.0361103470,
	-0.0000000000, -0.0334888257, -0.0000000000, -0.0311971870,
	-0.0000000000, -0.0291755264, -0.0000000000, -0.0273776363,
	-0.0000000000, -0.0257673042, -0.0000000000, -0.0243157494,
	-0.0000000000, -0.0229998108, -0.0000000000, -0.0218006399,
	-0.0000000000, -0.0207027420, -0.0000000000, -0.0196932631,
	-0.0000000000, -0.0187614506, -0.0000000000, -0.0178982414,
	-0.0000000000, -0.0170959429, -0.0000000000, -0.0163479841,
	-0.0000000000, -0.0156487183, -0.0000000000, -0.0149932668,
	-0.0000000000, -0.0143773929, -0.0000000000, -0.0137973997,
	-0.0000000000, -0.0132500473, -0.0000000000, -0.0127324845,
	-0.0000000000, -0.0122421921, -0.0000000000, -0.0117769368,
	-0.0000000000, -0.0113347310, -0.0000000000, -0.0109138011,
	-0.0000000000, -0.0105125586, -0.0000000000, -0.0101295776,
	-0.0000000000, -0.0097635740, -0.0000000000, -0.0094133886,
	-0.0000000000, -0.0090779724, -0.0000000000, -0.0087563740,
	-0.0000000000, -0.0084477282, -0.0000000000, -0.0081512469,
	-0.0000000000, -0.0078662107, -0.0000000000, -0.0075919615,
	-0.0000000000, -0.0073278960, -0.0000000000, -0.0070734605,
	-0.0000000000, -0.0068281459, -0.0000000000, -0.0065914829,
	-0.0000000000, -0.0063630386, -0.0000000000, -0.0061424131,
	-0.0000000000, -0.0059292361, -0.0000000000, -0.0057231643,
	-0.0000000000, -0.0055238792, -0.0000000000, -0.0053310847,
	-0.0000000000, -0.0051445053, -0.0000000000, -0.0049638842,
	-0.0000000000, -0.0047889815, -0.0000000000, -0.0046195735,
	-0.0000000000, -0.0044554506, -0.0000000000, -0.0042964166,
	-0.0000000000, -0.0041422875, -0.0000000000, -0.0039928907,
	-0.0000000000, -0.0038480636, -0.0000000000, -0.0037076536,
	-0.0000000000, -0.0035715167, -0.0000000000, -0.0034395171,
	-0.0000000000, -0.0033115266, -0.0000000000, -0.0031874241,
	-0.0000000000, -0.0030670949, -0.0000000000, -0.0029504304,
	-0.0000000000, -0.0028373275, -0.0000000000, -0.0027276884,
	-0.0000000000, -0.0026214200, -0.0000000000, -0.0025184340,
	-0.0000000000, -0.0024186459, -0.0000000000, -0.0023219754,
	-0.0000000000, -0.0022283457, -0.0000000000, -0.0021376834,
	-0.0000000000, -0.0020499184, -0.0000000000, -0.0019649832,
	-0.0000000000, -0.0018828134, -0.0000000000, -0.0018033470,
	-0.0000000000, -0.0017265245, -0.0000000000, -0.0016522886,
	-0.0000000000, -0.0015805840, -0.0000000000, -0.0015113575,
	-0.0000000000, -0.0014445576, -0.0000000000, -0.0013801346,
	-0.0000000000, -0.0013180405, -0.0000000000, -0.0012582286,
	-0.0000000000, -0.0012006537, -0.0000000000, -0.0011452719,
	-0.0000000000, -0.0010920405, -0.0000000000, -0.0010409181,
	-0.0000000000, -0.0009918643, -0.0000000000, -0.0009448395,
	-0.0000000000, -0.0008998053, -0.0000000000, -0.0008567243,
	-0.0000000000, -0.0008155595, -0.0000000000, -0.0007762750,
	-0.0000000000, -0.0007388356, -0.0000000000, -0.0007032067,
	-0.0000000000, -0.0006693544, -0.0000000000, -0.0006372454,
	-0.0000000000, -0.0006068469, -0.0000000000, -0.0005781267,
	-0.0000000000, -0.0005510531, -0.0000000000, -0.0005255947,
	-0.0000000000, -0.0005017209, -0.0000000000, -0.0004794011,
	-0.0000000000, -0.0004586054, -0.0000000000, -0.0004393040,
	-0.0000000000, -0.0004214676, -0.0000000000, -0.0004050673,
	-0.0000000000, -0.0003900744, -0.0000000000, -0.0003764603,
	-0.0000000000, -0.0003641970, -0.0000000000, -0.0003532566,
	-0.0000000000, -0.0003436114, -0.0000000000, -0.0003352340,
	-0.0000000000, -0.0003280972, -0.0000000000, -0.0003221740,
	-0.0000000000, -0.0003174376, -0.0000000000, -0.0003138613,
	+0.0000000000
};

static float *ht_buffer;

void init_hilbert_transformer() {
	ht_buffer = malloc(HT_FILTER_SIZE * sizeof(float));
}

float get_hilbert(float in) {
	float filter_out;
	static int ht_buffer_idx;
	int filter_idx;

	ht_buffer[ht_buffer_idx++] = in / HILBERT_GAIN;
	if (ht_buffer_idx == HT_FILTER_SIZE) ht_buffer_idx = 0;

	filter_idx = ht_buffer_idx;
	filter_out = 0;
	for (int i = 0; i < HT_FILTER_SIZE; i++) {
		filter_out += ht_buffer[filter_idx++] * hilbert_fir[i];
		if (filter_idx == HT_FILTER_SIZE) filter_idx = 0;
	}

	return filter_out;
}

void exit_hilbert_transformer() {
	free(ht_buffer);
}
